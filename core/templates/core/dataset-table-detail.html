{% extends 'base.html' %}
{% load cache %}
{% load l10n %}
{% load static %}

{% block title %}
  {{ dataset.name }} - Datasets Table {{ table.name|capfirst }} - Brasil.IO
{% endblock %}

{% block head %}
  {{ block.super }}
  <link rel="stylesheet" type="text/css" href="{% static 'css/vanillajs-datepicker.min.css' %}">
{% endblock %}

{% block alert %}
  {% if messages %}
    {% for message in messages %}
      {% with message=message|safe type=message.tags %}
        {% include 'includes/toast.html' %}
      {% endwith %}
    {% endfor %}
  {% endif %}
{% endblock %}

{% block content %}{% localize off %}
  <div class="section-breadcrumbs">
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dataset-list' %}">Datasets</a></li>
        <li class="breadcrumb-item" aria-current="dataset">
          <a href="{% url 'core:dataset-detail' dataset.slug %}">{{ dataset.name }}</a>
        </li>
        <li class="breadcrumb-item" aria-current="page">
          <span class="dropdown">
            <a href="#" class="dropdown-toggle link-secondary" id="dropdownMenu" data-bs-toggle="dropdown" aria-expanded="false">
              {{ table.name|capfirst }}
            </a>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu">
              {% for element in dataset.tables %}
                {% if table.name != element.name %}
                  <li>
                    <a
                      class="dropdown-item" 
                      href="{% url 'core:dataset-table-detail' dataset.slug element.name %}"
                    >
                      {{ element.name|capfirst }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
          </span>
        </li>
      </ol>
    </nav>
  </div>
  <div class="section-datasets">
    <div class="row gy-2">
      <div class="col-12">
        <div class="card-info">
          <div class="card-body col-lg-6">
            <h1 class="fs-2">{{ table.name|capfirst }}</h1>
            {% if table.short_description != None %}
              <h2 class="fs-5">{{ table.short_description }}</h2>
            {% endif %}
            {% if table.description != None %}
              <p>{{ table.description }}</p>
            {% endif %}
            <p>
              Quer <b>baixar os dados completos</b> ou precisa 
              <b>acessá-los de maneira automatizada</b>?
              <a href="https://blog.brasil.io/2020/10/10/como-acessar-os-dados-do-brasil-io/">
                <b>leia a documentação</b>
              </a>
              e depois
              <a href="{{ dataset.files_url }}">
                baixe o dataset completo
              </a>
              ou
              <a href="{% url 'v1:dataset-detail' dataset.slug %}">
                utilize nossa API
              </a>.
            </p>
          </div>
        </div>
      </div>
      <div class="col-12 pb-2">
        <div class="card shadow p-2">
          <div class="card-body row">
            <ul 
              class="nav nav-pills nav-fill mb-3 
              id="pills-tab" 
              role="tablist"
            >
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link active" 
                  id="pills-filtrar-tab" 
                  data-bs-toggle="pill" 
                  data-bs-target="#pills-filtrar" 
                  type="button" role="tab" 
                  aria-controls="pills-filtrar" 
                  aria-selected="true"
                >
                  Filtrar dados
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  id="pills-metadados-tab" 
                  data-bs-toggle="pill" 
                  data-bs-target="#pills-metadados" 
                  type="button" 
                  role="tab" 
                  aria-controls="pills-metadados" 
                  aria-selected="false"
                >
                  Metadados
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button 
                  class="nav-link" 
                  id="pills-referencias-tab" 
                  data-bs-toggle="pill" 
                  data-bs-target="#pills-referencias" 
                  type="button" role="tab" 
                  aria-controls="pills-referencias" 
                  aria-selected="false"
                >
                  Referências
                </button>
              </li>
            </ul>
            <div class="tab-content" id="pills-tabContent">
              <div 
                class="tab-pane fade fade show active" 
                id="pills-filtrar" role="tabpanel" 
                aria-labelledby="pills-filtrar-tab"
              >
                <div id="form">
                  <form method="get">
                    <div class="row g-4">
                      <div class="col-sm-6 col-lg-4">
                        <label for="search" class="form-label">Busca</label>
                        <input 
                          type="text" 
                          class="form-control" 
                          id="search" 
                          aria-describedby="Busca" 
                          value="{{ search_term }}"
                          name="search"
                        >
                      </div>
                      {% for field in filter_form %}
                        <div class="col-sm-6 col-lg-4">                            
                          <label class="form-label">{{ field.label }}</label>
                          <div class="input-group">
                            {{ field }}
                          </div>
                          {% if field.errors %}
                            <div class="small text-danger">
                              {{ field.errors }}
                            </div>
                          {% endif %}
                        </div>
                      {% endfor %}
                      <div class="col-12 d-flex justify-content-end">
                        <input class="btn btn-primary w-25" type="submit" value="Filtrar">
                      </div>
                    </div>
                  </form>
                </div>
              </div>
              <div 
                class="tab-pane fade" 
                id="pills-metadados" 
                role="tabpanel" 
                aria-labelledby="pills-metadados-tab"
              >
                <h2 class="fs-5 mb-2">
                  Dicionário de Dados - Tabela {{ table.name }}
                </h2>
  
                <table class="table table-bordered table-hover table-striped">
                  <thead>
                    <tr>
                      <th>Coluna</th>
                      <th>Tipo</th>
                      <th>Título</th>
                      <th>Descrição</th>
                    </tr>
                  </thead>
  
                  <tbody>
                    {% for field in table.fields %}
                      <tr>
                        <td> {{ field.name }} </td>
                        <td>
                          {{ field.type }}
                          {% if field.options_text %}
                            ({{ field.options_text }})
                          {% endif %}
                        </td>
                        <td> {{ field.title }} </td>
                        <td> {{ field.description }} </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div 
                class="tab-pane fade" 
                id="pills-referencias" 
                role="tabpanel" 
                aria-labelledby="pills-referencias-tab"
              >
                <h2 class="fs-5">
                  Referências desta base de dados na mídia
                </h2>
                <div>

                </div>
                <table class="table table-bordered table-hover table-striped">
                  <thead>
                    <tr>
                      <th>Título</th>
                      <th>Autor</th>
                      <th>Categoria</th>
                      <th>Link</th>
                    </tr>
                  </thead>

                  <tbody>
                    {% if clipping|length > 0 %}
                      {% for link in clipping %}
                        {% if link.clipping.published %}
                          <tr onclick="window.open('{{ link.clipping.url }}', '_blank' )" style="cursor: pointer;"
                            title="Clique para acessar o link">
                            <td> {{ link.clipping.title }}</td>
                            <td> {% if link.clipping.author %}{{ link.clipping.author }}{% else %} --- {% endif %} </td>
                            <td> {{ link.clipping.category }} </td>
                            <td class="blue-text text-darken-2"> {{ link.clipping.url|truncatechars:30}}</td>
                          </tr>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <tr>
                        <td> --- </td>
                        <td> --- </td>
                        <td> Nenhum link publicado</td>
                        <td> --- </td>
                      </tr>
                    {% endif %}
                  </tbody>

                </table>
                {% if user.is_authenticated %}
                 <div class="d-flex justify-content-end">
                   <a class="btn btn-outline-primary" href="{% url 'core:dataset-form-clipping' %}?next={{ request.path|urlencode }}">
                     Sugerir Referência
                   </a>
                 </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 pt-2">
        <h1 class="fs-2">Dados</h1>
        <div class="row">
          <div class="col-12 col-md-6 small">
            Captura em {{ version.collected_at }}.<br>
            {% if table.import_date %}
              Importação feita em {{ table.import_date }}.
            {% endif %}
          </div>
          <div class="col-12 col-md-6 pt-4 pb-2 py-md-0">
            {% if total_count > 0 and total_count <= max_export_rows and querystring %}
              <div class="col-12 d-flex justify-content-end mb-1">
                <a 
                  class="btn-small btn btn-primary "
                  data-bs-toggle="tooltip" data-bs-placement="top" 
                  title="No máximo {{ max_export_rows|localize }} registros serão
                          exportados. Caso você necessite de mais dados, considere baixar
                          o dataset completo clicando no link abaixo"
                  href="{% url 'core:dataset-table-detail' slug table.name %}?{% if querystring %}{{ querystring }}&amp;{% endif %}format=csv"
                >
                  Baixar resultado em CSV
                </a>
              </div>
              <div class="col-12 d-flex justify-content-end">
                <span class="small">
                  <a href="{{ dataset.files_url }}" title="Baixar dataset acompleto">Dataset completo</a>.
                </span>
              </div>
              {% else %}
              <div class="col-12 d-flex justify-content-end">
                <a class="btn-small btn btn-primary" href="{{ dataset.files_url }}" target="_blank">
                  Baixar dados completos em CSV
                </a>
              </div>
            {% endif %}
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <ul class="pagination justify-content-end align-items-center py-2 small">
              <li class="pe-2"> {{ data.start_index|localize }}-{{ data.end_index|localize }} de um total de {{ total_count|localize }}</li>
              {% if data.has_previous %}
              <li> 
                <a
                  class="btn btn-small btn-outline-secondary p-2 ms-1"
                  href="?{% if querystring %}{{ querystring }}&amp;{% endif %}page={{ data.previous_page_number }}">
                  <i class="bi bi-chevron-left"></i>
                </a> 
              </li>
              {% endif %}

              {% if data.has_next %}
              <li>
                <a 
                  class="btn btn-small btn-outline-secondary p-2 ms-1" 
                  href="?{% if querystring %}{{ querystring }}&amp;{% endif %}page={{ data.next_page_number }}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </div>
          <div class="col-12 overflow-auto">
            {% with table_id=dataset.slug fields=table.fields %}
              {% include 'core/data-table.html' %}
            {% endwith %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endlocalize %}{% endblock %}

{% block script %}
  {{ block.super }}
  <script type="text/javascript" language="javascript"
    src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      $('.mdl-data-table').DataTable({
        "paging": false,
        "searching": false,
        "ordering": false,
        "bInfo": false,
      });
    });
  </script>
{% endblock %}

{% block bodyscript %}
  {{ block.super }}
  <script src="{% static 'js/vanillajs-datepicker.min.js'%}"></script>
  <script src="{% static 'js/vanillajs-datepicker-starter.js'%}"></script>
{% endblock %}